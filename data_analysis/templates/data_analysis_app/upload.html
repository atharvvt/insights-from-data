<!DOCTYPE html>
<html>
  <head>
    <title>Data Analysis App</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center">Upload CSV for Analysis</h1>
      <form method="post" enctype="multipart/form-data" class="my-4">
        {% csrf_token %} {{ form.as_p }}
        <div class="mb-3">
          <label for="chunksize" class="form-label"
            >Data Visualization Chunk Size</label
          >
          <input
            type="number"
            id="chunksize"
            name="chunksize"
            class="form-control"
            min="1"
            step="1"
            value="100"
          />
          <small
            id="chunksizeWarning"
            class="form-text text-danger"
            style="display: none"
          >
            Warning: Chunk size greater than 1000 may cause slower loading
            times.
          </small>
        </div>
        <button type="submit" class="btn btn-primary">Upload</button>
      </form>

      {% if results %}
      <div class="mt-4">
        <h2 class="text-center">Analysis Results</h2>

        <h3>First Few Rows</h3>
        <div class="table-responsive">{{ results.head|safe }}</div>

        <h3>Summary Statistics</h3>
        <div class="table-responsive">{{ results.summary|safe }}</div>

        <h3>Missing Values</h3>
        <div class="table-responsive">{{ results.missing|safe }}</div>

        <h3>Visualizations</h3>

        <!-- Dropdown to select the column -->
        <div class="mb-3">
          <label for="columnSelect" class="form-label"
            >Select a x-axis Column for the Chart</label
          >
          <select id="columnSelect" class="form-control">
            {% for column in results.columns %}
            <option value="{{ column }}">{{ column }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="columnSelect_y" class="form-label"
            >Select a y-axis Column for the Chart</label
          >
          <select id="columnSelect_y" class="form-control">
            {% for column in results.columns %}
            <option value="{{ column }}">{{ column }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="chart_type" class="form-label"
            >Select the Chart Type</label
          >
          <select id="chart_type" class="form-control">
            <option value="line">Line</option>
            <option value="bar">Bar</option>
            <option value="scatter">Scatter</option>
            <option value="bubble">Bubble</option>
            <option value="doughnut">Doughnut</option>
            <option value="radar">Radar</option>
            <option value="pie">Pie</option>
          </select>
        </div>

        <!-- Button to generate the chart -->
        <button id="generateChartBtn" class="btn btn-primary mb-3">
          Generate Chart
        </button>

        <!-- Canvas to render the chart -->
        <div class="row">
          <div class="col-12">
            <canvas id="chartCanvas"></canvas>
          </div>
        </div>

        <script>
          let chartInstance = null;
          let chartsData = {{ results.charts_data|safe }};
          const ctx = document.getElementById('chartCanvas').getContext('2d');

          // Function to generate the chart
          function generateChart(xColumn, yColumn) {
              const chart_type = document.getElementById('chart_type').value;

              // Find the relevant chart data for the selected y-axis column
              const selectedChartData_y = chartsData.find(data => data.label === yColumn);
              const selectedChartData_x = chartsData.find(data => data.label === xColumn);

              console.log("y",selectedChartData_y)
              console.log("X",selectedChartData_x)

              if (!selectedChartData_x || !selectedChartData_y) return; // Exit if no data found for the selected column

              const xData = selectedChartData_x.y_data || [];  // Get x_data (index or selected x-axis column)
              const yData = selectedChartData_y.y_data || [];  // Get y_data for the selected column

              console.log("xData",xData)
              console.log("yData",yData)


              // Destroy previous chart instance (if any)
              if (chartInstance) {
                  chartInstance.destroy();
              }

              // Create a new chart
              chartInstance = new Chart(ctx, {
                  type: chart_type, // Chart type from dropdown
                  data: {
                      labels: xData, // Set x-axis labels
                      datasets: [{
                          label: yColumn, // Label for the dataset
                          data: yData, // Data points for the y-axis
                          borderColor: 'rgba(75, 192, 192, 1)',
                          borderWidth: 2,
                          fill: false
                      }]
                  },
                  options: {
                      responsive: true,
                      scales: {
                          x: {
                              title: {
                                  display: true,
                                  text: xColumn || 'Index' // Default x-axis title
                              }
                          },
                          y: {
                              title: {
                                  display: true,
                                  text: yColumn
                              }
                          }
                      }
                  }
              });
          }

          // Attach event listener to the "Generate Chart" button
          document.getElementById('generateChartBtn').addEventListener('click', function() {
              const xColumn = document.getElementById('columnSelect').value;
              const yColumn = document.getElementById('columnSelect_y').value;
              generateChart(xColumn, yColumn);
          });

          // Initialize the chart with the first column (or default column)
          const initialYColumn = document.getElementById('columnSelect_y').value;
          generateChart(null, initialYColumn); // Use index as default x-axis
        </script>
      </div>
      {% endif %}
    </div>
  </body>
</html>
